---
layout: post
cover: 'assets/images/shiroAlice.png'
title: MyBatis
date: 2021-03-07
tags: java web
author: sjh
description: 由JavaWeb-Spring分支出来，主要讲述原始Mybatis的用法
---

# :bird:MyBatis

mybatis是一个优秀的持久层框架，通过配置的方式即可对数据库进行持久化操作。推荐IDEA插件[FreeMyBatisPlugin](https://plugins.jetbrains.com/plugin/8321-free-mybatis-plugin)。

## 配置详解

**Maven坐标**

```xml
<dependency>
  <groupId>org.mybatis</groupId>
  <artifactId>mybatis</artifactId>
  <version>x.x.x</version>
</dependency>
```

### XML核心配置

#### 运行环境配置

运行环境需要指定数据库连接池和事务管理类型。完成以下配置即可完成最简单的持久化操作。

- 数据源环境

  ```xml
  <environments default="id">
      <environment id="">
          <transactionManager type="JDBC"/>
          <dataSource type="POOLED">
              <property name="" value="${}"/>
          </dataSource>
      </environment>
  </environments>
  ```

  数据源环境可以配置多个，其中指定一个ID为默认运行环境，配置DataSource的方法与Spring配置相似，同样可以使用properties文件。

- 加载映射文件

  ```xml
  <mappers>
  	<mapper resource="xml-url"/>
  </mappers>
  ```

#### 详细配置

- **environment**

  `transactionManager`：事务管理器类型，分为 JDBC、MANAGED

  `dataSource`：连接池类型，分为UNPOOLED、POOLED、JNDI，**也可以指定一个实现`UnpooledDataSourceFactory`的类作为type，如果要使用第三方连接池就需要这么做**

  `JDBC`和`POOLED`是最常用的，其他功能不做解释。

- **mapper**

  加载映射器可以使用多种方式，如以下三种：

  `resource`：相对类路径，相当于`classpath:`，用于加载映射器配置文件

  `class`：加载类，通过全限定类名加载，用于加载实现映射器接口的类（注解配置）

  `packagename`：加载包名下所有的类，同样是用于注解配置

- **properties**

  加载配置文件，使用`resource="path"`加载类下路径的文件，不需要加classpath

- **typeAliases**

  定义类型别名，用于简化全限定类名，创建别名和真名的映射关系。Mybatis内部将Java基础类型与包装器类型映射起来了，所以使用`int`、`double`等名称时，对应的是包装器类名。


### XML映射关系配置

#### 命名空间

每个映射文件对应一个命名空间，需要在标签内指定。命名空间的作用同Java包，使用映射关系时，需要以命名空间为开头的路径。

```xml
<mapper namespace="spaceName"></mapper>
```

#### sql语句配置

`id`是语句的标识符，sql语句可以直接写在标签中。

- SELECT

  ```xml
  <!--resultType是返回结果的类型，指定一个类Mybatis能够自动封装-->
  <select id="" resultType="">sql</select>
  ```

- UPDATE

  `<update id="" parameterType="">sql</update>`

- DELETE

  `<delete id="" >sql</delete>`

- INSERT

  `<insert id="" >sql</insert>`

##### 使用占位符

mybatis中占位符用`#{name}`表示，这个占位符是安全的，与Jdbc的`?`一样。在符号内部可以填写多个属性，如限定这个占位符的类型等，更多属性的设置请到官方文档中查询。

```sql
#{id, javaType=int, jdbcType=NUMERIC}
```

**用实体对象作为占位符参数**

Mybatis具备将复杂对象的属性配置到占位符中的功能，其中对象的属性名需要和占位符内`name`的参数名保持一致，mybatis即可自动的配置到占位符中。

sql标签使用`parameterType`属性可以指定该条语句所需要的参数对象类型，在缺省的情况下Mybatis能够自动推断。

##### ResultMap

结果应映射，通过`resultType`指定的类型，能够被mybatis自动创建并设置其中的属性值，当列名和属性名匹配上时，不需要额外配置，而复杂情况下可以通过显式配置`resultMap`的方式完成映射。

1.  配置一个所需的resultMap

   ```xml
   <resultMap  id="" type="class">
       <!--把class的属性名同列名关联起来-->
   	<result property="name" column="name"/>
   </resultMap>
   ```

2.  将sql语句的`resultType`更换为`resultMap`

   ```xml
   <select resultMap="mapId">sql</select>
   ```

[更加复杂的高级结果映射请看官方文档](https://mybatis.org/mybatis-3/zh/sqlmap-xml.html#Result_Maps)包含多表联查需要的复杂嵌套映射

##### 缓存优化

当一条语句被调用时，mybatis能够将其返回结果缓存起来，若有多次查询则可以使用缓存直接返回。

Select语句默认是打开缓存的，缓存开启方式如下：

在sql语句标签中添加属性`useCache="true"`即可开启，当使用属性`flushCache="true"`时，调用sql会刷新缓存区，默认为`false`

## 动态SQL

## JAVA-API  

### 快速入门

```java
//1. 加载核心配置
InputStream configStream = Resources.getResourcesAsStream("sqlMapConfig.xml");
//2. 获得SqlSession工厂对象
SqlSessionFactory factory = new SqlSessionFactoryBuilder().build(configStream);
//3. SqlSession对象
SqlSession session = factory.openSession();
//4. 执行sql语句
List<Object> list = session.selectList("mapping-parttern");
// 提交事务
session.commit();
//5. 释放SqlSession
session.close();
```

### 常用对象详解

- SqlSession

  mybatis主要的java接口，一切数据库操作都是由这个对象完成的。其地位类似于JdbcTemplate，在使用spring时也能通过IOC进行注入。

  主要方法有`selectXxx()`、`update()`、`delete()`以及事务管理的`commit、rollback`等

- SqlSessionFactoryBuilder

  用于创建SqlSessionFactory的对象，其中构建方法为`build()`，支持使用`InputStream`加载配置文件来创建工厂对象。

- SqlSessionFactory

  创建SqlSession对象的工厂类，用`openSession()`方法创建，可以使用其重载来设置SqlSession的一些属性，如是否自动提交事务以及事物的隔离级别等。

  引用官方文档的一段话

  > SqlSessionFactory 有六个方法创建 SqlSession 实例。通常来说，当你选择其中一个方法时，你需要考虑以下几点：
  >
  > - **事务处理**：你希望在 session 作用域中使用事务作用域，还是使用自动提交（auto-commit）？（对很多数据库和/或 JDBC 驱动来说，等同于关闭事务支持）
  > - **数据库连接**：你希望 MyBatis 帮你从已配置的数据源获取连接，还是使用自己提供的连接？
  > - **语句执行**：你希望 MyBatis 复用 PreparedStatement 和/或批量更新语句（包括插入语句和删除语句）吗？

## 日志系统